@page "/fidelity-form"
@using FidelityCard.Lib.Models
@using System.Text.Json
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager NM

<PageTitle>Completa Profilo - Suns</PageTitle>

@if(IsVisible)
{
    <div class="min-vh-100 d-flex align-items-center bg-white">
        <div class="container py-4">
            <div class="row justify-content-center">
                <div class="col-md-10 col-lg-8">
                    <div class="card shadow-lg border-0" style="border-radius: 20px;">
                        <div class="card-header text-white text-center py-4 registration-header" style="border-top-left-radius: 20px; border-top-right-radius: 20px;">
                             <img src="img/logo.avif" alt="Logo" style="width: 80px; height: auto; filter: brightness(0) invert(1);" class="mb-2"/>
                            <h3 class="mb-0 fw-bold">👤 Completa il tuo Profilo</h3>
                            <p class="mb-0 small opacity-75">Suns - Zero & Company</p>
                        </div>
                        <div class="card-body p-4 p-md-5">
                            
                             <div class="alert alert-info border-0 bg-light shadow-sm mb-4">
                                <div class="d-flex">
                                    <div class="me-3 text-primary fs-4">
                                        <i class="bi bi-info-circle-fill"></i>
                                    </div>
                                    <div>
                                        <h6 class="alert-heading fw-bold mb-1">Benvenuto!</h6>
                                        <p class="mb-0 text-muted small">Per completare la registrazione e ottenere la tua <strong>Fidelity Card</strong>, inserisci i tuoi dati reali. I campi contrassegnati sono obbligatori.</p>
                                    </div>
                                </div>
                            </div>

                            @if(Success)
                            {
                                <div class="text-center py-5">
                                    <div class="mb-4">
                                        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                                    </div>
                                    <h2 class="fw-bold mb-3">Registrazione Completata!</h2>
                                    <p class="text-muted mb-4 lead">Grazie per esserti registrato.</p>
                                    <p class="mb-2">Ti abbiamo inviato una email con la tua <strong>Fidelity Card digitale</strong>.</p>
                                    <p class="text-muted small">Controlla la tua casella di posta (anche nello spam).</p>
                                </div>
                            }
                            else
                            {
                                <EditForm Model="Fidelity" OnSubmit="OnHandleSubmit">
                                    <DataAnnotationsValidator />
                                    
                                    @if (!string.IsNullOrEmpty(ErrorMessage))
                                    {
                                         <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                            <i class="bi bi-exclamation-octagon me-2"></i> @ErrorMessage
                                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" @onclick='() => ErrorMessage = ""'></button>
                                        </div>
                                    }

                                    <div class="row g-3">
                                        <!-- Anagrafica -->
                                        <div class="col-12"><h6 class="text-uppercase text-muted border-bottom pb-2 mb-3 mt-2 small fw-bold">Dati Anagrafici</h6></div>
                                        
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <InputText id="Nome" @bind-Value="Fidelity.Nome" class="form-control" placeholder=" " />
                                                <label for="Nome">Nome</label>
                                            </div>
                                            <ValidationMessage For="@(() => Fidelity.Nome)" class="text-danger small ms-1" />
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <InputText id="Cognome" @bind-Value="Fidelity.Cognome" class="form-control" placeholder=" " />
                                                <label for="Cognome">Cognome</label>
                                            </div>
                                            <ValidationMessage For="@(() => Fidelity.Cognome)" class="text-danger small ms-1" />
                                        </div>

                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <InputDate id="DataNascita" @bind-Value="Fidelity.DataNascita" class="form-control" placeholder=" " />
                                                <label for="DataNascita">Data di nascita</label>
                                            </div>
                                            <ValidationMessage For="@(() => Fidelity.DataNascita)" class="text-danger small ms-1" />
                                        </div>
                                        <div class="col-md-6">
                                             <div class="form-floating">
                                                <select id="Sesso" class="form-select" @onchange="(e) => Fidelity.Sesso = (string?)e.Value" value="@Fidelity.Sesso">
                                                    <option value="" disabled selected>Seleziona...</option>
                                                    @foreach (var item in Helpers.SessoType)
                                                    {
                                                        <option value="@item.Value">@item.Key</option>
                                                    }
                                                </select>
                                                <!-- sesso label stays static or floating depending on browser, usually floating for select works with label after -->
                                                <label for="Sesso">Sesso</label>
                                            </div>
                                            <ValidationMessage For="@(() => Fidelity.Sesso)" class="text-danger small ms-1" />
                                        </div>

                                        <!-- Contatti -->
                                         <div class="col-12"><h6 class="text-uppercase text-muted border-bottom pb-2 mb-3 mt-4 small fw-bold">Contatti e Residenza</h6></div>

                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <InputText id="Email" @bind-Value="Fidelity.Email" class="form-control bg-light" placeholder=" " readonly />
                                                <label for="Email">Email (non modificabile)</label>
                                            </div>
                                            <ValidationMessage For="@(() => Fidelity.Email)" class="text-danger small ms-1" />
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <InputText id="Cellulare" @bind-Value="Fidelity.Cellulare" class="form-control" placeholder=" " />
                                                <label for="Cellulare">Cellulare</label>
                                            </div>
                                            <ValidationMessage For="@(() => Fidelity.Cellulare)" class="text-danger small ms-1" />
                                        </div>

                                        <div class="col-12">
                                            <div class="form-floating">
                                                <InputText id="Indirizzo" @bind-Value="Fidelity.Indirizzo" class="form-control" placeholder=" " />
                                                <label for="Indirizzo">Indirizzo</label>
                                            </div>
                                            <ValidationMessage For="@(() => Fidelity.Indirizzo)" class="text-danger small ms-1" />
                                        </div>

                                        <div class="col-md-4">
                                            <div class="form-floating">
                                                <InputText id="Localita" @bind-Value="Fidelity.Localita" class="form-control" placeholder=" " />
                                                <label for="Localita">Località</label>
                                            </div>
                                            <ValidationMessage For="@(() => Fidelity.Localita)" class="text-danger small ms-1" />
                                        </div>
                                         <div class="col-md-4">
                                            <div class="form-floating">
                                                <InputText id="Provincia" @bind-Value="Fidelity.Provincia" class="form-control" placeholder=" " style="text-transform: uppercase;" @onblur="() => Fidelity.Provincia = Fidelity.Provincia?.ToUpper()" />
                                                <label for="Provincia">Provincia (Sigla)</label>
                                            </div>
                                            <ValidationMessage For="@(() => Fidelity.Provincia)" class="text-danger small ms-1" />
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-floating">
                                                <InputText id="Cap" @bind-Value="Fidelity.Cap" class="form-control" placeholder=" " />
                                                <label for="Cap">CAP</label>
                                            </div>
                                             <ValidationMessage For="@(() => Fidelity.Cap)" class="text-danger small ms-1" />
                                        </div>
                                         <div class="col-md-4 d-none"> 
                                            <div class="form-floating">
                                                <InputText id="Nazione" @bind-Value="Fidelity.Nazione" class="form-control" placeholder=" " style="text-transform: uppercase;" @onblur="() => Fidelity.Nazione = Fidelity.Nazione?.ToUpper()" />
                                                <label for="Nazione">Nazione</label>
                                            </div>
                                            <ValidationMessage For="@(() => Fidelity.Nazione)" class="text-danger small ms-1" />
                                        </div>
                                    </div>

                                    <div class="d-grid mt-5">
                                        <button type="submit" class="btn btn-registration btn-lg text-white py-3 shadow-sm">
                                            <i class="bi bi-check-lg me-2"></i> Conferma e Registrati
                                        </button>
                                    </div>
                                </EditForm>
                            }

                            <div class="mt-4 text-center">
                                <small class="text-muted opacity-75">
                                    <i class="bi bi-shield-lock-fill me-1"></i> 
                                    I tuoi dati sono trattati in conformità alla normativa sulla privacy.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}


@code {
    // leggo il parametro "token" dalla query string
    [SupplyParameterFromQuery(Name = "token")] public string Token { get; set; } = string.Empty;

    private string ErrorMessage { get; set; } = string.Empty;
    Fidelity Fidelity = new();
    public static CustomSettings? CustomSettings { get; set; } = null;
    private bool Success { get; set; } = false;

    private bool IsVisible { get; set; } = true;
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool first)
    {
        await base.OnAfterRenderAsync(first);

        // l'if qui sotto non dovrebbe servire più
        if (CustomSettings == null)
        {
            // leggo dal Manifest i dati relativi a custom_settings
            var manifestData = await JS.InvokeAsync<Dictionary<string, JsonElement>>("manifestInterop.getManifest");
            CustomSettings = JsonSerializer.Deserialize<CustomSettings>(manifestData["custom_settings"]);

            // effettuo chiamata al server per leggere contenuto del token
            var actionurl = $"{CustomSettings?.Endpoint ?? string.Empty}/api/FidelityCard/EmailConfirmation?token={Token}";
            var fileContent = await Http.GetStringAsync(actionurl);
            if (!string.IsNullOrEmpty(fileContent))
            {
                // ricavo i parametri (e-mail e store) dal file letto tramite api 
                string[] param = fileContent.Split("\r\n");
                Fidelity.Email = param[1];
                Fidelity.Store = param[0];
                IsVisible = true;
            }
            else
            {
                NM.NavigateTo("/error");
            }
            StateHasChanged();
        }
    }
    
    private async Task OnHandleSubmit()
    {
        ErrorMessage = string.Empty;

        var actionurl = CustomSettings?.EndpointSede;
        //var actionurl = "http://fidelity.lilloeivagabondi.it:5530/ArcaExec/arca_dataexchange";
        var dbsede = CustomSettings?.DbNameSede;
        if (string.IsNullOrEmpty(dbsede))
        {
            throw new Exception("Il nome del database sede non è stato specificato");
        }

        // effettuo chiamata api esterna per creare nuova fidelity
        var request = new RequestSede(){
            Request = new()
            {
                DbName = dbsede,
                SpName = "xTSP_API_Put_Fidelity",
                CalledFrom = "APP FIDELIT"
            },
            Parameters = [
                new() { Name = "store", Value = Fidelity.Store },
                new() { Name = "tipo", Value = "D" },
                new() { Name = "nome", Value = Fidelity.Nome },
                new() { Name = "cognome", Value = Fidelity.Cognome },
                new() { Name = "sesso", Value = Fidelity.Sesso },
                new() { Name = "data_nascita", Value = Fidelity.DataNascita?.ToString("yyyyMMdd") },
                //  new() { Name = "codice_fiscale", Value = "" },
                new() { Name = "indirizzo", Value = Fidelity.Indirizzo },
                new() { Name = "localita", Value = Fidelity.Localita },
                new() { Name = "cap", Value = Fidelity.Cap },
                new() { Name = "provincia", Value = Fidelity.Provincia },
                new() { Name = "nazione", Value = Fidelity.Nazione },
                new() { Name = "cellulare", Value = Fidelity.Cellulare },
                new() { Name = "email", Value = Fidelity.Email }
            ]
        };
        var response = await Http.PostAsJsonAsync(actionurl, request);


        if (response.IsSuccessStatusCode)
        {
            // analizzo risposta e leggo codice fidelity
            var json = await response.Content.ReadFromJsonAsync<JsonDocument>();
            if (json != null) 
            {
                var jsonRoot = json.RootElement;
                var responseArray = jsonRoot.GetProperty("response").EnumerateArray();
                var responseElement = responseArray.First();
                var datasetArray = responseElement.GetProperty("dataset").EnumerateArray();
                var datasetElement = datasetArray.First();
                string? CdFidelity = datasetElement.GetProperty("codice_fidelity").GetString();

                if (CdFidelity != null)
                {
                    Fidelity.CdFidelity = CdFidelity;

                    // effettuo chiamata al server per salvare nuova fidelity
                    actionurl = Path.Combine(CustomSettings?.Endpoint ?? string.Empty, "api/FidelityCard");
                    response = await Http.PostAsJsonAsync(actionurl, Fidelity);

                    if (response.IsSuccessStatusCode)
                    {
                        // Salvataggio riuscito
                        // Mostra messaggio di successo
                        Success = true;
                        // Fidelity = new(); // Non resettiamo per ora, o se resettiamo non importa perché mostriamo il success message
                    }
                    else
                    {
                        ErrorMessage = await response.Content.ReadAsStringAsync();
                    }
                }
                else
                {
                    ErrorMessage = "Non è stato possibile ottenere il nuovo codice fidelity dalla sede.";
                }
            }
            else
            {
                ErrorMessage = "Non è stato possibile ottenere il nuovo codice fidelity dalla sede.";
            }                       
        }

    }
}

