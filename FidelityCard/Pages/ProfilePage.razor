@page "/profilo"
@using FidelityCard.Lib.Models
@using System.Text.Json
@inject HttpClient Http
@inject NavigationManager NM
@inject IJSRuntime JS

<PageTitle>Il tuo Profilo - Fidelity Card</PageTitle>

@if (IsLoading)
{
    <div class="d-flex justify-content-center align-items-center vh-100">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Caricamento...</span>
        </div>
    </div>
}
else if (FidelityUser != null)
{
    <div class="container py-4">
        <div class="row align-items-center mb-4">
            <div class="col">
                <h2 class="fw-bold mb-0">Ciao, @FidelityUser.Nome! ðŸ‘‹</h2>
                <p class="text-muted">Bentornato nella tua area personale.</p>
            </div>
            <!-- Se avessimo i punti reali, li mostreremmo qui -->
            <!-- 
            <div class="col-auto">
                <div class="badge bg-warning text-dark fs-6 px-3 py-2 shadow-sm">
                    <i class="bi bi-star-fill me-1"></i> Punti: 0
                </div>
            </div>
            -->
        </div>

        <div class="row justify-content-center">
            <!-- Fidelity Card Digitale -->
            <div class="col-lg-6 mb-4">
                <div class="card border-0 shadow-lg text-white h-100" 
                     style="background: linear-gradient(135deg, #105a12ff 0%, #053e30ff 100%); border-radius: 15px; min-height: 300px;">
                    <div class="card-body p-4 position-relative overflow-hidden d-flex flex-column justify-content-between">
                        <!-- Background Decoration -->
                        <div class="position-absolute top-0 end-0 p-3 opacity-25">
                            <i class="bi bi-credit-card-2-front display-1"></i>
                        </div>
                        
                        <!-- Header Card -->
                        <div class="d-flex justify-content-between align-items-start mb-4">
                            <div>
                                <h5 class="text-uppercase mb-0 ls-1 fw-bold">Fidelity Card</h5>
                                <small class="text-white-50">Suns</small>
                            </div>
                            <i class="bi bi-wifi fs-3"></i>
                        </div>

                        <!-- QR Code Area -->
                        <div class="text-center py-3 flex-grow-1 d-flex flex-column justify-content-center align-items-center">
                            <div class="bg-white p-2 d-inline-block rounded shadow-sm">
                                @if (!string.IsNullOrEmpty(QrCodeUrl))
                                {
                                    <img src="@QrCodeUrl" alt="QR Code" width="150" height="150" style="display: block;">
                                }
                            </div>
                            <div class="mt-3 font-monospace fs-4 bg-white text-dark px-3 py-1 rounded shadow-sm opacity-90">
                                @FormatCode(FidelityUser.CdFidelity)
                            </div>
                        </div>

                        <!-- Footer Card -->
                        <div class="d-flex justify-content-between align-items-end mt-4">
                            <div>
                                <small class="text-white-50 d-block text-uppercase" style="font-size: 0.7rem;">Titolare</small>
                                <span class="fw-bold fs-5">@FidelityUser.Nome @FidelityUser.Cognome</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
             <div class="col-12 text-center">
                 <div class="alert alert-light border shadow-sm d-inline-block text-start">
                     <div class="d-flex">
                        <i class="bi bi-info-circle-fill text-primary me-3 fs-4"></i>
                        <div>
                            <strong>Come usare la card?</strong>
                            <p class="mb-0 text-muted small">Mostra questo QR Code in cassa al momento del pagamento per accumulare punti.</p>
                        </div>
                     </div>
                 </div>
             </div>
        </div>
    </div>
}
else
{
    <div class="container py-5 text-center">
        <div class="alert alert-danger">
            <h4 class="alert-heading">Errore!</h4>
            <p>Impossibile caricare il profilo. Il link potrebbe essere scaduto o non valido.</p>
            <hr>
            <p class="mb-0">Per favore, richiedi un nuovo link di accesso inserendo la tua email nella pagina principale.</p>
        </div>
    </div>
}

<style>
    .ls-1 { letter-spacing: 1px; }
    .opacity-90 { opacity: 0.9; }
</style>

@code {
    [SupplyParameterFromQuery(Name = "token")] public string Token { get; set; } = string.Empty;

    private Fidelity? FidelityUser { get; set; }
    private bool IsLoading { get; set; } = true;
    private string QrCodeUrl { get; set; } = "";
    public static CustomSettings? CustomSettings { get; set; } = null;


    protected override async Task OnAfterRenderAsync(bool first)
    {
        await base.OnAfterRenderAsync(first);

        if (first)
        {
             if (CustomSettings == null)
            {
                var manifestData = await JS.InvokeAsync<Dictionary<string, JsonElement>>("manifestInterop.getManifest");
                CustomSettings = JsonSerializer.Deserialize<CustomSettings>(manifestData["custom_settings"]);
            }
            
            await LoadProfile();
        }
    }

    private async Task LoadProfile()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            if (string.IsNullOrEmpty(Token))
            {
                IsLoading = false;
                StateHasChanged();
                return;
            }

            var endpoint = CustomSettings?.Endpoint ?? "";
            var profileUrl = $"{endpoint}/api/FidelityCard/Profile?token={Token}";
            
            FidelityUser = await Http.GetFromJsonAsync<Fidelity>(profileUrl);

            if (FidelityUser != null && !string.IsNullOrEmpty(FidelityUser.CdFidelity))
            {
                // Costruisci URL QR Code
                QrCodeUrl = $"{endpoint}/api/FidelityCard/QRCode/{FidelityUser.CdFidelity}";
            }
        }
        catch (Exception)
        {
            FidelityUser = null;
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private string FormatCode(string? code)
    {
        if (string.IsNullOrEmpty(code)) return "----";
        return code;
    }
}
