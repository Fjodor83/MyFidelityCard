@page "/"
@using FidelityCard.Lib.Models
@using System.Text.Json

@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Registrazione - Suns</PageTitle>

<!-- Toast Notification -->
<div class="toast-container-custom">
    <div class="toast-custom @(IsToastVisible ? "show" : "") @(IsToastError ? "error" : "success")">
        <div class="toast-icon">
            <i class="bi @(IsToastError ? "bi-x-circle-fill" : "bi-check-circle-fill")"></i>
        </div>
        <div class="toast-content">
            <h6>@(IsToastError ? "Attenzione" : "Successo")</h6>
            <p>@ToastMessage</p>
        </div>
    </div>
</div>

<div class="min-vh-100 d-flex align-items-center py-4" style="background: var(--primary-gradient);">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-sm-11 col-md-9 col-lg-7 col-xl-6 col-xxl-5">

                <!-- Main Registration Card -->
                <div class="card border-0 shadow-lg fade-in-up" style="border-radius: 24px; overflow: hidden;">
                    <div class="card-body p-4 p-md-5 text-center bg-white position-relative">

                        <!-- Decorative top accent -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--primary-gradient);"></div>

                        <!-- Branding -->
                        <div class="mb-4 mt-2">
                            <div class="d-inline-block p-3 rounded-circle shadow-sm mb-3" style="background: #ffffff;">
                                <img src="images/Suns.webp" alt="SUNS Logo" style="width: 70px; height: auto;" />
                            </div>
                            <h6 class="text-uppercase text-secondary fw-bold letter-spacing-2 mb-0" style="font-size: 0.75rem; letter-spacing: 1.5px;">Zero & Company</h6>
                        </div>

                        <!-- Welcome Message -->
                        <h1 class="mb-2 fw-bold h2 text-dark">Benvenuto!</h1>
                        <p class="text-muted mb-4 px-2 px-md-3" style="line-height: 1.6; font-size: 0.95rem;">
                            Entra nel mondo <strong>Suns</strong>. Registrati per ottenere la tua Card digitale, sconti e vantaggi esclusivi.
                        </p>

                        <!-- Registration Form -->
                        <div class="mb-3 text-start">
                            <div class="form-group">
                                <label class="form-label-modern ms-1 mb-2 small fw-medium">La tua Email</label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text bg-light border-end-0 rounded-start-3 ps-3">
                                        <i class="bi bi-envelope text-muted"></i>
                                    </span>
                                    <input @bind="emailRegistrazione"
                                           @bind:event="oninput"
                                           type="email"
                                           class="form-control form-control-modern border-start-0 rounded-end-3"
                                           placeholder="nome@esempio.com"
                                           style="box-shadow: none; padding: 0.75rem 1rem;"
                                           @onkeypress="@(async e => { if (e.Key == "Enter") await InviaRegistrazione(); })" />
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-registration btn-lg w-100 mb-4 py-3 fw-bold shadow-sm" @onclick="InviaRegistrazione" disabled="@isInvio">
                            @if (isInvio)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Invio in corso...</span>
                            }
                            else
                            {
                                <span><i class="bi bi-magic me-2"></i> Ricevi Link di Accesso</span>
                            }
                        </button>

                        <!-- Benefits -->
                        <div class="mt-4 pt-3 border-top">
                            <h6 class="mb-3 text-uppercase text-muted fw-bold" style="font-size: 0.7rem; letter-spacing: 1.2px;">✨ I tuoi vantaggi esclusivi</h6>
                            <div class="row text-start g-2 g-md-3">
                                <div class="col-6">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-success bg-opacity-10 p-2 me-2 flex-shrink-0" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                            <i class="bi bi-star-fill" style="font-size: 0.85rem; color: var(--bs-success);"></i>
                                        </div>
                                        <span class="small fw-medium">Punti acquisto</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-success bg-opacity-10 p-2 me-2 flex-shrink-0" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                            <i class="bi bi-gift-fill" style="font-size: 0.85rem; color: var(--bs-success);"></i>
                                        </div>
                                        <span class="small fw-medium">Premi fedeltà</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-success bg-opacity-10 p-2 me-2 flex-shrink-0" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                            <i class="bi bi-tag-fill" style="font-size: 0.85rem; color: var(--bs-success);"></i>
                                        </div>
                                        <span class="small fw-medium">Sconti %</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-success bg-opacity-10 p-2 me-2 flex-shrink-0" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                                            <i class="bi bi-patch-check-fill" style="font-size: 0.85rem; color: var(--bs-success);"></i>
                                        </div>
                                        <span class="small fw-medium">Promo VIP</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Store Info Footer -->
                <div class="text-center mt-3 fade-in-up delay-200">
                    @if (!string.IsNullOrEmpty(puntoVenditaNome))
                    {
                        <div class="d-inline-block bg-white bg-opacity-90 px-3 py-2 rounded-pill shadow-sm mb-2">
                            <small class="text-muted fw-bold" style="font-size: 0.8rem;">
                                <i class="bi bi-geo-alt-fill text-danger me-1"></i> @puntoVenditaNome (@puntoVenditaCodice)
                            </small>
                        </div>
                    }

                    <div>
                        <button class="btn btn-sm text-white text-opacity-75 border-0" @onclick="Logout" style="background: transparent;">
                            <small><i class="bi bi-box-arrow-right me-1"></i>Logout Operatore</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



@code {
    [SupplyParameterFromQuery(Name = "store")] public string Store { get; set; } = "NE001";

    private string emailRegistrazione = "";
    private bool isInvio = false;
    private string puntoVenditaNome = "";
    private string puntoVenditaCodice = "";

    // Toast State
    private string? ToastMessage { get; set; }
    private bool IsToastError { get; set; }
    private bool IsToastVisible { get; set; }

    public static CustomSettings? CustomSettings { get; set; } = null;

    protected override async Task OnInitializedAsync()
    {
        puntoVenditaCodice = Store;
        puntoVenditaNome = "Punto Vendita";
        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool first)
    {
        if (first)
        {
            try
            {
                var manifestData = await JS.InvokeAsync<Dictionary<string, JsonElement>>("manifestInterop.getManifest");
                if (manifestData != null && manifestData.ContainsKey("custom_settings"))
                {
                    CustomSettings = JsonSerializer.Deserialize<CustomSettings>(manifestData["custom_settings"]);
                }
            }
            catch (Exception)
            {
                // Ignore if manifest fails locally
            }
        }
    }

    private async void ShowToast(string message, bool isError)
    {
        if (string.IsNullOrWhiteSpace(message)) return;

        ToastMessage = message;
        IsToastError = isError;
        IsToastVisible = true;
        StateHasChanged();

        await Task.Delay(5000); // 5 seconds auto-dismiss

        IsToastVisible = false;
        StateHasChanged();
    }

    private async Task InviaRegistrazione()
    {
        if (string.IsNullOrWhiteSpace(emailRegistrazione))
        {
            ShowToast("Inserisci un'email valida.", true);
            return;
        }

        if (!new System.ComponentModel.DataAnnotations.EmailAddressAttribute().IsValid(emailRegistrazione))
        {
            ShowToast("Il formato dell'email non è corretto.", true);
            return;
        }

        isInvio = true;
        StateHasChanged();

        try
        {
            var endpoint = CustomSettings?.Endpoint ?? "";
            var currentStore = string.IsNullOrWhiteSpace(Store) ? "NE001" : Store;
            var validationUrl = $"{endpoint}/api/FidelityCard/EmailValidation?email={Uri.EscapeDataString(emailRegistrazione)}&store={Uri.EscapeDataString(currentStore)}";
            var response = await Http.GetAsync(validationUrl);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<JsonElement>();
                bool userExists = false;

                try
                {
                    userExists = result.GetProperty("userExists").GetBoolean();
                }
                catch { }

                if (userExists)
                {
                    ShowToast("Questa mail è già registrata. Controlla la tua posta per accedere al profilo.", false);
                }
                else
                {
                    ShowToast("Link di registrazione inviato! Controlla la tua email.", false);
                }

                emailRegistrazione = "";
            }
            else
            {
                ShowToast("Errore durante la richiesta. Riprova più tardi.", true);
            }
        }
        catch (Exception)
        {
            ShowToast("Errore di connessione o servizio non disponibile.", true);
        }
        finally
        {
            isInvio = false;
            StateHasChanged();
        }
    }

    private void Logout()
    {
        Navigation.NavigateTo("/", true);
    }
}